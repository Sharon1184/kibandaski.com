import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import {
  getFirestore, collection, getDoc, getDocs, doc, setDoc, updateDoc, arrayUnion, query, where
} from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHhmbgDA_D13LcnEWgtr5Unu7uihBpGPE",
  authDomain: "food-ae7ff.firebaseapp.com",
  projectId: "food-ae7ff",
  storageBucket: "food-ae7ff.appspot.com",
  messagingSenderId: "1058214228504",
  appId: "1:1058214228504:web:f1f059be00c9aeaf7cc96d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let cartId = localStorage.getItem("cartId");
if (!cartId) {
  cartId = "cart_" + Math.random().toString(36).substring(2);
  localStorage.setItem("cartId", cartId);
}

const params = new URLSearchParams(window.location.search);
const foodId = params.get("id");
let currentFood = null;

const loadFoodDetail = async () => {
  if (!foodId) {
    document.getElementById("food-title").innerText = "Food ID not specified.";
    return;
  }

  const foodRef = doc(db, "foods", foodId);
  const foodSnap = await getDoc(foodRef);

  if (!foodSnap.exists()) {
    document.getElementById("food-title").innerText = "Food Not Found";
    return;
  }

  const food = foodSnap.data();
  currentFood = { ...food, id: foodId };

  // Set main food display
  document.getElementById("food-img").src = food.imageUrl;
  document.getElementById("food-title").innerText = food.name;
  document.getElementById("food-desc").innerText = food.description;
  document.getElementById("food-price").innerText = "Ksh. " + food.price;

  loadOtherVendors(food.name);
};

const loadOtherVendors = async (foodName) => {
  const q = query(collection(db, "foods"), where("name", "==", foodName));
  const querySnapshot = await getDocs(q);

  const container = document.createElement("div");
  container.style.marginTop = "30px";
  container.innerHTML = `<h3>Other restaurants selling ${foodName}:</h3><div id="variants" style="display:flex;gap:10px;overflow-x:auto;padding:10px 0;"></div>`;
  document.querySelector(".food-detail-container").appendChild(container);

  const variantsDiv = document.getElementById("variants");

  querySnapshot.forEach(docSnap => {
    const item = docSnap.data();
    const card = document.createElement("div");
    card.style.minWidth = "150px";
    card.style.cursor = "pointer";
    card.innerHTML = `
      <img src="${item.imageUrl}" style="width:100%;height:100px;object-fit:cover;border-radius:6px;">
      <p style="font-weight:bold;">${item.restaurant}</p>
      <p>Ksh. ${item.price}</p>
    `;
    card.onclick = () => {
      window.location.href = `food-detail.html?id=${docSnap.id}`;
    };
    variantsDiv.appendChild(card);
  });
};

const addToCart = async () => {
  if (!currentFood) return;

  const cartRef = doc(db, "carts", cartId);
  const cartSnap = await getDoc(cartRef);

  if (cartSnap.exists()) {
    await updateDoc(cartRef, {
      items: arrayUnion(currentFood)
    });
  } else {
    await setDoc(cartRef, {
      items: [currentFood]
    });
  }

  alert("âœ… Added to cart!");
  updateCartCount();
};

const updateCartCount = async () => {
  const cartRef = doc(db, "carts", cartId);
  const cartSnap = await getDoc(cartRef);

  let count = 0;
  if (cartSnap.exists()) {
    count = cartSnap.data().items?.length || 0;
  }

  const cartIcon = document.querySelector(".cart");
  let badge = document.querySelector(".cart-badge");

  if (!badge) {
    badge = document.createElement("sup");
    badge.classList.add("cart-badge");
    cartIcon.appendChild(badge);
  }

  badge.innerText = count;
};

window.addEventListener("DOMContentLoaded", () => {
  loadFoodDetail();
  document.getElementById("add-to-cart-btn").addEventListener("click", addToCart);
  updateCartCount();
});
