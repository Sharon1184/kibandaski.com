<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Kibandaski Deliveries</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f6f6f6;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .price-row {
      display: flex;
      justify-content: space-between;
      margin: 0.5rem 0;
    }
    .total {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 1rem;
    }
    .btn {
      width: 100%;
      padding: 1rem;
      background-color: #28a745;
      border: none;
      color: white;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1.5rem;
    }
    .btn:hover {
      background-color: #218838;
    }
    .empty-msg {
      text-align: center;
      font-size: 1.1rem;
      color: #555;
    }
    .empty-msg a {
      color: #007bff;
      text-decoration: none;
    }
    .empty-msg a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container" id="checkout-container">
    <h1>Checkout</h1>

    <div id="details">
      <div class="price-row"><span>Subtotal:</span><span id="subtotal">-</span></div>
      <div class="price-row"><span>Delivery Fee:</span><span id="deliveryFee">-</span></div>
      <div class="price-row total"><span>Total:</span><span id="grandTotal">-</span></div>
      <button class="btn" id="payBtn">Proceed to Payment</button>
    </div>

    <div class="empty-msg" id="emptyCartMsg" style="display: none;">
      Your cart is empty. <br>
      <a href="cart.html">Go back and add some delicious food üç≤</a>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const cartId = localStorage.getItem("cartId");
    const subtotal = localStorage.getItem("subtotal");
    const deliveryFee = localStorage.getItem("deliveryFee");
    const grandTotal = localStorage.getItem("grandTotal");

    const details = document.getElementById("details");
    const emptyCartMsg = document.getElementById("emptyCartMsg");

    if (!cartId || !subtotal || !deliveryFee || !grandTotal) {
      // Hide checkout details and show empty message
      details.style.display = "none";
      emptyCartMsg.style.display = "block";
    } else {
      // Show the cart prices
      document.getElementById("subtotal").textContent = `Ksh. ${subtotal}`;
      document.getElementById("deliveryFee").textContent = `Ksh. ${deliveryFee}`;
      document.getElementById("grandTotal").textContent = `Ksh. ${grandTotal}`;

      // Handle payment
      document.getElementById("payBtn").addEventListener("click", async () => {
        try {
          await addDoc(collection(db, "orders"), {
            cartId,
            subtotal: Number(subtotal),
            deliveryFee: Number(deliveryFee),
            grandTotal: Number(grandTotal),
            status: "Pending",
            createdAt: serverTimestamp(),
          });

          alert("Order placed successfully!");

          // Clear cart info and redirect
          localStorage.removeItem("cartId");
          localStorage.removeItem("subtotal");
          localStorage.removeItem("deliveryFee");
          localStorage.removeItem("grandTotal");

          window.location.href = "thankyou.html";
        } catch (error) {
          console.error("Error placing order:", error);
          alert("Something went wrong. Please try again.");
        }
      });
    }
  </script>
</body>
</html>
