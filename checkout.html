<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - Kibandaski Deliveries</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .order-box {
      max-width: 600px;
      margin: auto;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      margin-top: 30px;
    }
    .order-box h2 {
      text-align: center;
    }
    .order-box p {
      margin: 10px 0;
    }
    .place-order-btn {
      margin-top: 20px;
      padding: 10px;
      background: green;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>

<div class="order-box">
  <h2>Order Summary</h2>
  <p id="cart-details">Loading...</p>
  <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, addDoc, collection, onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAHhmbgDA_D13LcnEWgtr5Unu7uihBpGPE",
    authDomain: "food-ae7ff.firebaseapp.com",
    projectId: "food-ae7ff",
    storageBucket: "food-ae7ff.appspot.com",
    messagingSenderId: "1058214228504",
    appId: "1:1058214228504:web:f1f059be00c9aeaf7cc96d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const cartId = localStorage.getItem("cartId");
  let cartItems = [];
  let subtotal = Number(localStorage.getItem("subtotal")) || 0;
  let deliveryFee = Number(localStorage.getItem("deliveryFee")) || 0;
  let total = Number(localStorage.getItem("grandTotal")) || 0;
  let currentOrderId = null;
  let customerPhone = null;

  const displayCart = async () => {
    const cartRef = doc(db, "carts", cartId);
    const cartSnap = await getDoc(cartRef);
    const details = document.getElementById("cart-details");

    if (cartSnap.exists()) {
      const data = cartSnap.data();
      cartItems = data.items || [];

      let summary = cartItems.map(item => {
        return `${item.name} x ${item.quantity || 1} @ Ksh. ${item.price}`;
      }).join("<br>");

      summary += `<br><br>Subtotal: Ksh. ${subtotal}`;
      summary += `<br>Delivery Fee: Ksh. ${deliveryFee}`;
      summary += `<br><strong>Total: Ksh. ${total}</strong>`;

      details.innerHTML = summary;
    } else {
      details.innerHTML = "Cart not found.";
    }
  };

  window.addEventListener("DOMContentLoaded", displayCart);

  window.placeOrder = async () => {
    customerPhone = prompt("Enter your phone number to continue:");

    if (!customerPhone) {
      alert("Order cancelled.");
      return;
    }

    const newOrder = {
      cartId,
      phone: customerPhone,
      items: cartItems,
      subtotal,
      deliveryFee,
      total,
      status: "Pending",
      createdAt: new Date()
    };

    try {
      const orderRef = await addDoc(collection(db, "orders"), newOrder);
      currentOrderId = orderRef.id;
      alert("Order placed! Waiting for a rider to accept...");

      listenForOrderStatusChange(orderRef.id);
    } catch (error) {
      alert("Failed to place order: " + error.message);
    }
  };

  function listenForOrderStatusChange(orderId) {
    const orderDocRef = doc(db, "orders", orderId);

    onSnapshot(orderDocRef, async (snapshot) => {
      const data = snapshot.data();
      if (data && data.status === "Taken") {
        alert("Rider has accepted your order! Sending M-Pesa prompt...");

        try {
          const response = await fetch("https://tinypesa.com/api/v1/express/initialize", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "ApiKey": "hP88os4XcngLKHXO345KqMi-WGS2tWG85sVX-qlQ"
            },
            body: new URLSearchParams({
              amount: total,
              msisdn: customerPhone,
              account_no: orderId
            })
          });

          const result = await response.json();

          if (result.success) {
            alert("M-Pesa prompt sent. Check your phone.");
          } else {
            alert("Failed to send M-Pesa prompt: " + JSON.stringify(result));
          }
        } catch (error) {
          alert("TinyPesa error: " + error.message);
        }
      }
    });
  }
</script>

</body>
</html>
